<!DOCTYPE html><html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>æˆèªä¿„ç¾…æ–¯æ–¹å¡Š</title>
<style>
 :root{
  --board-bg:#111;
  --cell-size:40px;/* ç”± JS å‹•æ…‹è¦†å¯« */
  --block-bg:#f0c040;
  --block-color:#000;
  --slot-bg:#444;
 }
 *{box-sizing:border-box;margin:0;padding:0;font-family:"Noto Sans TC",sans-serif;-webkit-user-select:none;user-select:none}
 body{display:flex;justify-content:center;align-items:center;height:100vh;background:#222;color:#fff;overflow:hidden}
 #game{position:relative;display:flex;flex-direction:column;align-items:center}
 #board{background:var(--board-bg);position:relative;touch-action:none}
 .block{position:absolute;width:var(--cell-size);height:var(--cell-size);background:var(--block-bg);border-radius:4px;display:flex;justify-content:center;align-items:center;font-weight:700;font-size:calc(var(--cell-size)*0.6);color:var(--block-color);box-shadow:0 0 4px rgba(0,0,0,.4);transition:box-shadow .12s}
 .block.selected{box-shadow:0 0 0 3px #00eaff inset,0 0 6px #00eaff}
 #slots{display:flex;gap:4px;margin-top:4px}
 .slot{width:var(--cell-size);height:var(--cell-size);background:var(--slot-bg);border:2px dashed #888;border-radius:4px;display:flex;justify-content:center;align-items:center;position:relative}
 #score{margin-top:8px;font-size:1.2rem}
 .ctrls{position:fixed;bottom:calc(env(safe-area-inset-bottom,0px)+10px);left:0;width:100%;display:flex;justify-content:center;gap:16px;z-index:30}
 .ctrls button{padding:12px;font-size:1.3rem;border:none;border-radius:50%;background:#f0c040;color:#000;width:60px;height:60px;display:flex;justify-content:center;align-items:center;box-shadow:0 2px 4px rgba(0,0,0,.4);cursor:pointer}
 #overlay{position:absolute;inset:0;background:rgba(0,0,0,.8);display:flex;flex-direction:column;justify-content:center;align-items:center;gap:20px;z-index:40;backdrop-filter:blur(4px)}
 #overlay.hidden{display:none}
 #overlay button{padding:10px 24px;font-size:1.1rem;border:none;border-radius:6px;background:#f0c040;color:#000;cursor:pointer}
</style>
</head>
<body>
 <div id="game">
  <div id="board"></div>
  <div id="slots"></div>
  <div id="score">å¾—åˆ†ï¼š0 / 20</div>
  <div class="ctrls">
   <button id="leftBtn">â—€ï¸</button>
   <button id="downBtn">â–¼</button>
   <button id="rightBtn">â–¶ï¸</button>
  </div>
  <div id="overlay" class="hidden">
   <div id="message"></div>
   <button id="restartBtn">é‡æ–°é–‹å§‹</button>
   <button id="endBtn">çµæŸéŠæˆ²</button>
  </div>
 </div>
<script>
(()=>{
 /* ======== å¸¸é‡ ======== */
 const COLS=10,ROWS=18,TICK=500,MAX_SCORE=20; // è¡Œæ•¸èª¿ç‚º 18ï¼Œåº•ä¸‹é¡å¤–é¡¯ç¤ºå››æ§½
 const idioms=["ç•«è›‡æ·»è¶³","äº¡ç¾Šè£œç‰¢","å°ç‰›å½ˆç´","å®ˆæ ªå¾…å…”","æ©è€³ç›œéˆ´","æŒ‡é¹¿ç‚ºé¦¬","åˆ»èˆŸæ±‚åŠ","ç›²äººæ‘¸è±¡","äº•åº•ä¹‹è›™","è‰æœ¨çš†å…µ","ç´™ä¸Šè«‡å…µ","è² èŠè«‹ç½ª","è‡ªç›¸çŸ›ç›¾","ç•«é¾é»ç›","æ¯å¼“è›‡å½±","å››æµ·ç‚ºå®¶","ç™¾ç™¼ç™¾ä¸­","ä¸€å¸†é¢¨é †","é †æ‰‹ç‰½ç¾Š","è‡¥è–ªå˜—è†½"];
 /* ======== DOM ======== */
 const boardEl=document.getElementById('board');
 const slotsEl=document.getElementById('slots');
 const scoreEl=document.getElementById('score');
 const overlayEl=document.getElementById('overlay');
 const msgEl=document.getElementById('message');
 const leftBtn=document.getElementById('leftBtn');
 const rightBtn=document.getElementById('rightBtn');
 const downBtn=document.getElementById('downBtn');
 const restartBtn=document.getElementById('restartBtn');
 const endBtn=document.getElementById('endBtn');
 /* ======== ç‹€æ…‹ ======== */
 let cellSize,matrix,timer=null,score=0,completed=new Set();
 let falling=[]; // ç•¶å‰æ‰¹æ¬¡ä¸‹è½å­—å¡Š
 let currentBatch=0;
 let active=null;
 const slots=[null,null,null,null]; // å„²å­˜å››å€‹æ§½å°æ‡‰çš„ block or null
 /* ======== å·¥å…·å‡½å¼ ======== */
 const rand=a=>a[Math.floor(Math.random()*a.length)];
 const shuffle=a=>{const arr=[...a];for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}return arr};
 function resize(){cellSize=Math.floor(Math.min(window.innerWidth/(COLS+2),window.innerHeight/(ROWS+6)));document.documentElement.style.setProperty('--cell-size',cellSize+'px');boardEl.style.width=COLS*cellSize+'px';boardEl.style.height=ROWS*cellSize+'px';slotsEl.style.width=COLS*cellSize+'px';}
 window.addEventListener('resize',resize);resize();
 /* ======== åˆå§‹åŒ–æ’æ§½ DOM ======== */
 function buildSlots(){slotsEl.innerHTML='';for(let i=0;i<4;i++){const d=document.createElement('div');d.className='slot';slotsEl.appendChild(d);} }
 buildSlots();
 const slotElems=[...slotsEl.children];
 /* ======== æ£‹ç›¤ ======== */
 function initMatrix(){matrix=Array.from({length:ROWS},()=>Array(COLS).fill(null));}
 function createBlock(ch,batchId){const el=document.createElement('div');el.className='block';el.textContent=ch;boardEl.parentElement.appendChild(el);return {ch,row:-1,col:0,el,batchId,slotIndex:null};}
 function setPos(b){if(b.slotIndex!==null){const rect=slotElems[b.slotIndex].getBoundingClientRect();const parentRect=boardEl.parentElement.getBoundingClientRect();b.el.style.left=rect.left-parentRect.left+'px';b.el.style.top=rect.top-parentRect.top+'px';}else{b.el.style.left=b.col*cellSize+'px';b.el.style.top=b.row*cellSize+'px';}}
 function collision(r,c){return r>=ROWS||(r>=0&&matrix[r][c]);}
 /* ======== ç”Ÿæˆæ‰¹æ¬¡ ======== */
 function spawnBatch(){if(completed.size>=idioms.length)return;currentBatch++;
 const remain=idioms.filter(i=>!completed.has(i));const word=rand(remain);
 const extras=shuffle(idioms.join('').split('').filter(c=>!word.includes(c))).slice(0,2);
 const chars=shuffle([...word.split(''),...extras]);
 const colsPool=shuffle([...Array(COLS).keys()]);
 chars.forEach((ch,i)=>{const b=createBlock(ch,currentBatch);b.col=colsPool[i%COLS];setPos(b);makeDraggable(b);falling.push(b);} );
 }
 /* ======== æ‹–æ›³ ======== */
 function makeDraggable(block){let dragging=false,startX=0,startY=0,offsetX=0,offsetY=0;const el=block.el;
 function setActive(b){if(active)active.el.classList.remove('selected');active=b;b.el.classList.add('selected');}
 el.addEventListener('pointerdown',e=>{e.preventDefault();dragging=true;setActive(block);startX=e.clientX;startY=e.clientY;const rect=el.getBoundingClientRect();offsetX=startX-rect.left;offsetY=startY-rect.top;el.setPointerCapture(e.pointerId);
 // è‹¥åŸæœ¬åœ¨ slotï¼Œæ¸…ç©º slot
 if(block.slotIndex!==null){slots[block.slotIndex]=null;block.slotIndex=null;}
 });
 el.addEventListener('pointermove',e=>{if(!dragging)return;const parentRect=boardEl.parentElement.getBoundingClientRect();el.style.left=e.clientX-offsetX-parentRect.left+'px';el.style.top=e.clientY-offsetY-parentRect.top+'px';});
 const endDrag=e=>{if(!dragging)return;dragging=false;el.releasePointerCapture(e.pointerId);
 // åˆ¤æ–·æ˜¯å¦é€²å…¥æ’æ§½
 let placed=false;
 slotElems.forEach((slotEl,idx)=>{const sr=slotEl.getBoundingClientRect();if(e.clientX>sr.left && e.clientX<sr.right && e.clientY>sr.top && e.clientY<sr.bottom && !slots[idx]){
   slots[idx]=block;block.slotIndex=idx;placed=true;setPos(block);
   // è‹¥ä¹‹å‰åœ¨çŸ©é™£ï¼Œç§»é™¤
   if(block.row>=0)matrix[block.row][block.col]=null;
 }});
 if(!placed){ // è‹¥æ”¾å›æ£‹ç›¤å…§ï¼Œå˜—è©¦å°æ‡‰åˆ—/æ¬„
   const parentRect=boardEl.getBoundingClientRect();const relX=e.clientX-parentRect.left;const relY=e.clientY-parentRect.top;
   const c=Math.floor(relX/cellSize);const r=Math.floor(relY/cellSize);
   if(c>=0&&c<COLS&&r>=0&&r<ROWS&&!collision(r,c)){
     block.col=c;block.row=r;setPos(block);matrix[r][c]=block; // é–å®š
   }else{ // å¦å‰‡æ‰åˆ°åŸæœ¬ä½ç½®æˆ–é ‚ç«¯
     if(block.row<0){block.col=Math.min(Math.max(block.col,0),COLS-1);setPos(block);}else{setPos(block);} }
 }
 checkSlots();
 };
 el.addEventListener('pointerup',endDrag);
 el.addEventListener('pointercancel',endDrag);
 }
 /* ======== å¡«æ»¿å››æ§½æª¢æŸ¥ ======== */
 function checkSlots(){if(slots.every(s=>s)){const word=slots.map(b=>b.ch).join('');const slotBatchId=slots[0].batchId;
 if(idioms.includes(word)){// æˆåŠŸ
   slots.forEach(b=>boardEl.parentElement.removeChild(b.el));
   // ç§»é™¤åŒæ‰¹æ¬¡å…¶ä»–å­—
   [...boardEl.parentElement.querySelectorAll('.block')].forEach(el=>{const b=findBlockByEl(el);if(b&&b.batchId===slotBatchId){if(matrix[b.row]&&matrix[b.row][b.col]===b)matrix[b.row][b.col]=null;boardEl.parentElement.removeChild(b.el);} });
   score++;updateScore();completed.add(word);
   clearSlots();applyGravity();if(score>=MAX_SCORE)win();else spawnBatch();
 }else{
   // ä¸æ˜¯æ­£ç¢ºæˆèªï¼Œé–ƒç´…æç¤ºä¸¦å½ˆå‡º
   slotElems.forEach(el=>{el.style.borderColor='#f00';setTimeout(()=>el.style.borderColor='#888',400);} );
 }
 }
 }
 function clearSlots(){for(let i=0;i<4;i++){slots[i]=null;} }
 /* ======== æŸ¥æ‰¾ block by element ======== */
 function findBlockByEl(el){return [...falling, ...matrix.flat().filter(Boolean), ...slots.filter(Boolean)].find(b=>b.el===el);} // ç°¡æ˜“æœå°‹
 /* ======== falling é‡åŠ› ======== */
 function tick(){for(let i=falling.length-1;i>=0;i--){const b=falling[i];if(b.slotIndex!==null)continue;const nr=b.row+1;if(!collision(nr,b.col)){b.row=nr;setPos(b);}else{if(b.row>=0){matrix[b.row][b.col]=b;}falling.splice(i,1);} }
 if(falling.length===0)spawnBatch();}
 function applyGravity(){for(let c=0;c<COLS;c++){for(let r=ROWS-2;r>=0;r--){if(matrix[r][c]&&!matrix[r+1][c]){let nr=r;while(!collision(nr+1,c))nr++;const blk=matrix[r][c];matrix[r][c]=null;matrix[nr][c]=blk;blk.row=nr;setPos(blk);} }} }
 /* ======== åˆ†æ•¸ ======== */
 function updateScore(){scoreEl.textContent=`å¾—åˆ†ï¼š${score} / ${MAX_SCORE}`;}
 /* ======== æ§åˆ¶æŒ‰éˆ•åªé‡å°é¸ä¸­å¡Š ======== */
 function moveActive(dx){if(!active||active.slotIndex!==null)return;const target=Math.min(Math.max(active.col+dx,0),COLS-1);if(!collision(active.row,target)){active.col=target;setPos(active);} }
 function softDropActive(){if(!active||active.slotIndex!==null)return;while(!collision(active.row+1,active.col))active.row++;setPos(active);matrix[active.row][active.col]=active;falling=falling.filter(b=>b!==active);active=null;}
 document.addEventListener('keydown',e=>{if(overlayEl.classList.contains('hidden')){if(e.key==='ArrowLeft')moveActive(-1);else if(e.key==='ArrowRight')moveActive(1);else if(e.key==='ArrowDown')softDropActive();}});
 leftBtn.onclick=()=>moveActive(-1);rightBtn.onclick=()=>moveActive(1);downBtn.onclick=softDropActive;
 /* ======== çµæŸ/å‹åˆ© ======== */
 function stop(){clearInterval(timer);timer=null;}
 function gameOver(){stop();msgEl.innerHTML=`Game Over!<br/>å¾—åˆ†ï¼š${score}`;overlayEl.classList.remove('hidden');}
 function win(){stop();msgEl.innerHTML='ğŸ†<br/>æ­å–œä½ å–å¾—æ»¿åˆ†ï¼';overlayEl.classList.remove('hidden');}
 /* ======== é‡è¨­ & é–‹å§‹ ======== */
 function reset(){boardEl.parentElement.querySelectorAll('.block').forEach(el=>el.remove());falling=[];active=null;completed.clear();score=0;updateScore();initMatrix();clearSlots();}
 function start(){overlayEl.classList.add('hidden');reset();spawnBatch();if(!timer)timer=setInterval(tick,TICK);} 
 restartBtn.onclick=start;endBtn.onclick=()=>overlayEl.innerHTML='<div style="font-size:2rem">è¬è¬éŠç©ï¼</div>';
 /* ======== å•Ÿå‹• ======== */
 start();
})();
</script>
</body>
</html>
