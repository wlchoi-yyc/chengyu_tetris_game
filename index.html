<!DOCTYPE html><html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
<title>成語俄羅斯方塊</title>
<style>
 :root{
  --board-bg:#111;
  --cell-size:40px;/* 會由JS動態覆寫 */
  --block-bg:#f0c040;
  --block-color:#000;
 }
 *{box-sizing:border-box;margin:0;padding:0;font-family:"Noto Sans TC",sans-serif;-webkit-user-select:none;user-select:none}
 body{height:100vh;background:#222;color:#fff;display:flex;justify-content:center;align-items:center;overflow:hidden}
 #game{position:relative;display:flex;flex-direction:column;align-items:center}
 #board{background:var(--board-bg);position:relative}
 .block{position:absolute;width:var(--cell-size);height:var(--cell-size);background:var(--block-bg);border-radius:4px;display:flex;justify-content:center;align-items:center;font-weight:700;font-size:calc(var(--cell-size)*0.6);color:var(--block-color);box-shadow:0 0 4px rgba(0,0,0,.4)}
 #score{margin-top:8px;font-size:1.2rem}
 .ctrls{position:fixed;bottom:calc(env(safe-area-inset-bottom,0px)+10px);left:0;width:100%;display:flex;justify-content:center;gap:12px;z-index:20}
 .ctrls button{padding:10px 18px;font-size:1.1rem;border:none;border-radius:6px;background:#f0c040;color:#000;cursor:pointer}
 #overlay{position:absolute;inset:0;background:rgba(0,0,0,.8);display:flex;flex-direction:column;justify-content:center;align-items:center;gap:20px;z-index:30;backdrop-filter:blur(4px)}
 #overlay.hidden{display:none}
 #message{font-size:1.6rem;line-height:1.4;text-align:center}
 #overlay button{padding:10px 20px;font-size:1.1rem;border:none;border-radius:6px;background:#f0c040;color:#000;cursor:pointer}
</style>
</head>
<body>
 <div id="game">
  <div id="board"></div>
  <div id="score">得分：0 / 20</div>
  <!-- 控制鍵放 fixed 區域，避免被瀏覽器 UI 遮擋 -->
  <div class="ctrls">
   <button id="leftBtn">◀︎</button>
   <button id="downBtn">▼</button>
   <button id="rightBtn">▶︎</button>
  </div>
  <div id="overlay" class="hidden">
   <div id="message"></div>
   <button id="restartBtn">重新開始</button>
   <button id="endBtn">結束遊戲</button>
  </div>
 </div>
<script>
(()=>{
 /* ======== 基本設定 ======== */
 const COLS=10,ROWS=20,TICK=500,MAX_SCORE=20;
 const idioms=["畫蛇添足","亡羊補牢","對牛彈琴","守株待兔","掩耳盜鈴","指鹿為馬","刻舟求劍","盲人摸象","井底之蛙","草木皆兵","紙上談兵","負荊請罪","自相矛盾","畫龍點睛","杯弓蛇影","四海為家","百發百中","一帆風順","順手牽羊","臥薪嘗膽"];
 const boardEl=document.getElementById("board"),scoreEl=document.getElementById("score"),overlayEl=document.getElementById("overlay"),msgEl=document.getElementById("message");
 const restartBtn=document.getElementById("restartBtn"),endBtn=document.getElementById("endBtn");
 const leftBtn=document.getElementById("leftBtn"),rightBtn=document.getElementById("rightBtn"),downBtn=document.getElementById("downBtn");
 let cellSize,matrix,falling=[],timer=null,score=0,currentBatch=0,completed=new Set();
 /* ======== 輔助 ======== */
 const rand=(arr)=>arr[Math.floor(Math.random()*arr.length)];
 const shuffle=(arr)=>{const a=[...arr];for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a};
 /* ======== Layout ======== */
 function resize(){cellSize=Math.floor(Math.min(window.innerWidth/(COLS+2),window.innerHeight/(ROWS+4)));document.documentElement.style.setProperty("--cell-size",cellSize+"px");boardEl.style.width=COLS*cellSize+"px";boardEl.style.height=ROWS*cellSize+"px";}
 window.addEventListener("resize",resize);resize();
 /* ======== Board ======== */
 function initMatrix(){matrix=Array.from({length:ROWS},()=>Array(COLS).fill(null));}
 function createBlock(ch,batchId){const el=document.createElement("div");el.className="block";el.textContent=ch;boardEl.appendChild(el);return {ch,row:-1,col:0,el,batchId}};
 function position(block){block.el.style.top=block.row*cellSize+"px";block.el.style.left=block.col*cellSize+"px";}
 function collision(r,c){return r>=ROWS||(r>=0&&matrix[r][c]);}
 /* ======== Spawn 6 字批次 ======== */
 function spawnBatch(){if(completed.size>=idioms.length)return;currentBatch++;
 const remaining=idioms.filter(i=>!completed.has(i));const idiom=rand(remaining);
 const extraChars=shuffle(idioms.join('').split('')).filter(ch=>!idiom.includes(ch)).slice(0,2);
 const chars=shuffle([...idiom.split(''),...extraChars]);
 const colsPool=shuffle([...Array(COLS).keys()]);
 chars.forEach((ch,i)=>{const block=createBlock(ch,currentBatch);block.col=colsPool[i%COLS];position(block);makeDraggable(block);falling.push(block);});
 }
 /* ======== Gravity ======== */
 function tick(){for(let i=falling.length-1;i>=0;i--){const b=falling[i];const nr=b.row+1;if(!collision(nr,b.col)){b.row=nr;position(b);}else{lock(b);falling.splice(i,1);} }
 if(falling.length===0)spawnBatch();}
 function lock(b){if(b.row<0){gameOver();return;}matrix[b.row][b.col]=b;checkClear();}
 function applyGravity(){for(let c=0;c<COLS;c++){
   for(let r=ROWS-2;r>=0;r--){if(matrix[r][c]&& !matrix[r+1][c]){let nr=r;while(!collision(nr+1,c))nr++;const blk=matrix[r][c];matrix[r][c]=null;matrix[nr][c]=blk;blk.row=nr;position(blk);} }
 }}
 /* ======== 檢查消行 ======== */
 function checkClear(){let clearedBatch=null;for(let r=0;r<ROWS;r++){
   for(let c=0;c<=COLS-4;c++){
     const seq=[matrix[r][c],matrix[r][c+1],matrix[r][c+2],matrix[r][c+3]];
     if(seq.every(cell=>cell)){
       const word=seq.map(x=>x.ch).join('');if(idioms.includes(word)&&!completed.has(word)){
         clearedBatch=seq[0].batchId;break;}
     }
   }
   if(clearedBatch)break;
 }
 if(clearedBatch!==null){for(let r=0;r<ROWS;r++){
   for(let c=0;c<COLS;c++){
     const cell=matrix[r][c];if(cell&&cell.batchId===clearedBatch){boardEl.removeChild(cell.el);matrix[r][c]=null;}
   }
 }
 completed.add(idioms.find(id=>id.split('').every(ch=>matrix.flat().every(b=>!(b&&b.ch===ch&&b.batchId===clearedBatch)))));
 score++;updateScore();applyGravity();if(score>=MAX_SCORE)win();}
 }
 /* ======== 分數/UI ======== */
 function updateScore(){scoreEl.textContent=`得分：${score} / ${MAX_SCORE}`;}
 /* ======== 拖曳 ======== */
 function makeDraggable(block){let dragging=false,startX=0,startCol=0;
 const el=block.el;
 el.addEventListener('pointerdown',e=>{e.preventDefault();dragging=true;startX=e.clientX;startCol=block.col;el.setPointerCapture(e.pointerId);});
 el.addEventListener('pointermove',e=>{if(!dragging)return;const dx=e.clientX-startX;const colOffset=Math.round(dx/cellSize);let target=Math.min(Math.max(startCol+colOffset,0),COLS-1);if(!collision(block.row,target)){block.col=target;position(block);}});
 const endDrag=()=>{dragging=false;};
 el.addEventListener('pointerup',endDrag);el.addEventListener('pointercancel',endDrag);
 }
 /* ======== 控制鍵與鍵盤 ======== */
 function move(delta){falling.forEach(b=>{if(!collision(b.row,b.col+delta)){b.col=Math.min(Math.max(b.col+delta,0),COLS-1);position(b);}});} // 同時移全部下落中方塊
 function softDrop(){falling.forEach(b=>{while(!collision(b.row+1,b.col))b.row++;position(b);lock(b);});falling=[];}
 document.addEventListener('keydown',e=>{if(overlayEl.classList.contains('hidden')){if(e.key==='ArrowLeft')move(-1);else if(e.key==='ArrowRight')move(1);else if(e.key==='ArrowDown')softDrop();}});
 leftBtn.onclick=()=>move(-1);rightBtn.onclick=()=>move(1);downBtn.onclick=softDrop;
 /* ======== 結束/勝利 ======== */
 function stop(){clearInterval(timer);timer=null;}
 function gameOver(){stop();msgEl.innerHTML=`Game Over!<br/>得分：${score}`;overlayEl.classList.remove('hidden');}
 function win(){stop();msgEl.innerHTML='🏆<br/>恭喜你取得滿分！';overlayEl.classList.remove('hidden');}
 /* ======== 遊戲啟動 ======== */
 function reset(){boardEl.innerHTML='';falling=[];completed.clear();score=0;updateScore();initMatrix();}
 function start(){overlayEl.classList.add('hidden');reset();spawnBatch();if(!timer)timer=setInterval(tick,TICK);} 
 restartBtn.onclick=start;endBtn.onclick=()=>overlayEl.innerHTML='<div style="font-size:2rem">謝謝遊玩！</div>';
 start();
})();
</script>
</body>
</html>
